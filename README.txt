- AozoraEpub3  README -

=== 説明 =======================================================================
青空文庫テキスト→ePub3変換
青空文庫の注記入りテキストファイルをePub3ファイル(zip圧縮)に変換するツールです

=== 利用上の注意 ===============================================================
　利用は自己責任でお願いします。
　現状、いくつか対応していない注記があります。
　青空文庫の注記仕様外の注記等で変換したxhtmlエラーで章ごと表示されない場合があります。
　表示の不具合や長い文書等で電子書籍端末がフリーズする場合があります。
　4バイト文字を出力すると対応していない端末では外字以降表示されない場合があります
　（変換しないオプション選択時は注記を表示）
　バグや変換できない注記があった配布サイトで報告お願いします。

=== 変換時の注意 ===============================================================
　コメントの異常、対応していない注記、変換できなかった外字はログに表示されるので
　適宜元テキスト修正してください。
　・仕様外や一部の揺らぎのある注記は対応しません
　・外字注記内で外字注記が使われている場合はエラーになります（対応予定無し）
　　→※［＃「姉」の正字、「女＋※［＃第3水準1-85-57］のつくり」 とログに出たら
　　　該当部分の元テキストを ※［＃「姉」の正字、U+59CA］に修正
　・注記内に注記がある底本コメント注記は削除してください

=== 動作環境 ===================================================================
Java 6 / Java 7 の動作環境 ( http://www.java.com/ja/ )

=== 使い方 =====================================================================
・インストール
  AozoraEpub3-1.0.6.zip を任意のフォルダに解凍します。

・起動
  AozoraEpub3.jar をダブルクリックして実行します。
  またはコンソールから "java -jar AozoraEpub3.jar" でも実行可。
  ※javaが見えなければフルパスで指定
    例: "C:\Program Files\Java\jre\bin\java.exe" -jar AozoraEpub3.jar

・変換
  表示されたアプレットに、変換したい青空文庫テキストファイル（拡張子txtまたはzip)
  （複数可）をドラッグ＆ドロップします。(「ファイル選択」から開くでも同じ)
  テキストファイルと同じ場所に「元ファイル名.epub」または「[著作者名] 表題.epub」
  のファイルが生成されます。
  ※テキストのない画像のみのzipを変換した場合は、画像のみのePubファイルを生成します。

=== 使い方 CUI =================================================================
・コマンドラインからの実行 (仮)
Usage: java -cp AozoraEpub3.jar AozoraEpub3 "青空文庫テキスト1.txt" "青空文庫テキスト2.zip"

※現状オプション指定は未対応 (すべてアップレットのデフォルト状態)


=== 画面設定 ===================================================================
・表題 本文内
　本文内のタイトルと著者名の有無を設定します。
　3行連続の場合はタイトルの次は副題してタイトルと連結します。
　本文中のタイトルは大きい文字で、著者名地付きに設定されます。
　画像や空行は無視されます。

・ファイル名優先
　"[著作者名] 表題.epub" のファイル名からタイトルと著者名を取得します。
　本文中のタイトル行と著者名の行のスタイル設定は本文内の選択に従います。

・表題左右中央
　表題、著者等のページを左右中央の単一ページで出力します。

・出力ファイル名に表題利用
　"[著作者名] 表題.epub" のファイル名で出力します。
　どちらも設定されていない場合は「元ファイル名.epub」で出力します。

・拡張子
　出力ファイルの拡張子を指定します。
　(Koboでの利用はkepub.epubを選択推奨)

・出力先
　出力先を指定する場合にフルパスを設定します。

・栞用ID出力
　Koboのkepubでの栞用のidを行のpタグに設定します。
　Koboのkepub以外の環境では不要です。

・半角2文字縦中横
　半角の2文字の数字、英字、!?を並べて縦書きにします。

・縦書き 横書き
　縦書きと横書きを指定します。
　それぞれに合わせたスタイルが設定されます。
　(基本的にビューア側で縦書き横書きの切り替えはできない？)

・表紙
　表紙の画像を先頭の画像、ファイル選択、URLで指定します。
　入力ファイル名と同じ画像(jpg,png)の場合は、入力ファイル(txr,zip)の拡張子以外が同じ名称の画像を表紙に利用します。
　(拡張子は以下の順でチェックpng,jpg,jpeg,gif)

・表紙ページ出力
　ePubの先頭に表紙ページ（画像は幅100％）を追加します。
　Reader等で表紙を出したい場合に指定してください。
　（先頭の画像を表紙に指定している場合は先頭に移動されませす）

・入力文字コード
　入力する青空文庫ファイルの文字コードを指定します。通常はMS932(SJIS)です。

・ePubファイル上書き
　同名のファイル(元ファイル名.epub)がすでにある場合でも上書きして出力します。

・確認
　変換前にタイトルと著者名を確認して編集するダイアログを表示します。
　修正したタイトルと著者名でメタデータが作成されます。
　本文は変更されません。

=== ファイルの説明 =============================================================
・プログラムファイル
  AozoraEpub3.jar   	ePub3変換ツール
                    	ダブルクリックまたは"java -jar AozoraEpub3.jar"で実行
  lib/*.jar         	利用ライブラリ (compress, Velocity) +アイコン

・ePub3テンプレート
  template/*        	ePub3テンプレート
  template/OPS/css/*.css	ePub3スタイル

・変換用設定ファイル
  chuki_tag_suf.txt	前方参照型注記を開始終了型注記に変換
  chuki_tag.txt    	注記をePubタグに変換
  chuki_alt.txt    	外字注記を代替文字に変換
  chuki_utf.txt    	外字注記(コード無し)をUTF-8文字に変換
  chuki_latin.txt  	ラテン文字注記をUTF-8に変換
  replace.txt      	文字置換設定ファイル

=== 対応している注記 ===========================================================
・基本的な注記に設定ファイルで対応
 chuki_tag.txt 参照
 
 例外的にプログラム処理しているもの
 ・字下げ連続時の［＃ここで字下げ終わり］の省略への対応
 ・字下げ折り返しと字下げ字詰めは数値化してインデント計算
 　［＃ここから○字下げ、折り返して●字下げ］［＃ここから○字下げ、●字詰め］
 ・字下げ複合はclassを合成（罫囲み、中央揃え）
 
 ・画像 (キャプション、サイズ指定未対応)
 ［＃説明（ファイル名）］
 <img src="ファイル名"/>
 
=== 対応している外字と特殊文字 =================================================
 ・外字注記をコード変換してUTF-8文字で出力 （UTF8コード、JISコードあり）
 ※［＃「さんずい＋垂」、unicode6DB6］
 ※［＃「さんずい＋垂」、U+6DB6、235-7］
 ※［＃「さんずい＋垂」、UCS6DB6、235-7］
 ※［＃「てへん＋劣」、第3水準1-84-77］
 
 ・UTF-8にない外字注記は代替文字を出力 (chuk_alt.txt)
 
 ・コード記述がない外字注記は名称からUTF-8に変換 (chuk_utf.txt)
 
 ・青空文庫特殊文字対応（《》［］〔〕｜＃※）
 ※［＃始め二重山括弧、1-1-52］ →《
 ※［＃終わり二重山括弧、1-1-53］ →》
 ※［＃始め角括弧、1-1-46］ →［
 ※［＃終わり角括弧、1-1-47］ →］
 ※［＃始めきっこう（亀甲）括弧、1-1-44］ →〔
 ※［＃終わりきっこう（亀甲）括弧、1-1-45］ →〕
 ※［＃縦線、1-1-35］ →｜
 ※［＃井げた、1-1-84］ →＃
 ※［＃米印、1-2-8］ →※
 
 ・くの字点「／＼」「／″＼」をUTF-8で出力

=== 未対応注記 =================================================================
 ・重複不可に定義された注記の間に含まれるルビ・圏点・縦横中
 ・ここから横組み
 ・窓見出し
 ・割り注
 ・訂正と「ママ」
 ・ルビとルビのように付く文字
 ・キャプション
 
=== Changes ====================================================================
[1.0.6]
b50-52
　- 字下げエラーになって字下げされないバグ修正
　- 表題取得で3行の時の副題優先取得オプション
　- 画像zip変換でcssが足りていなかったのを修正
b49
　- 改ページ後にbrタグが出ていたのを修正
　- 表題のタグがpの中にならないように変更
　- 出力先が無い場合にフォルダを作成するか確認
　- 確認ダイアログで次以降の変換前確認を設定
　- 出力先もファイルまたはフォルダのDnDで設定可能に
　- 他UI調整
b48
　- 画像が前にあると表題がエラーになるのを修正
b47
　- 改ページ後の改行が消えるバグ修正
　- 目次に画像ファイル名またはタイトルは出力しない
b46
　- 改ページ後の改行pタグ出力がおかしかったのを修正
　- フォント用cssを分離 (Readerでのフォント指定用)
b45
　- 改ページ処理を調整
　　　最初の文字やタグ出力時に改ページ処理
　　　空行はカウントして文字やタグ出力時にまとめて出力 (ページ最後の改行は出力しない)
　　　連続改ページ等での空ページは無視される (連続改ページする場合は全角スペース等入れる必要有り)
　- 2桁元号で1桁目のみ縦中横になっていたのを修正
　- 数字1文字の縦中横条件調整 (年1月 月2日 第3刷 第4版 第5巻)
　- 表題取得処理調整 (3行の場合2行目先頭が"―"でなく3行目が"訳""編纂""校訂で終われば2行目が著者)
　- ブロック注記とインライン注記のdivとspanの調整
b44
　- 字下げ字詰め注記で字詰めにならないバグ修正
　- 太字とゴシック体注記スタイル調整
　　　Koboデフォルトフォント時 → ゴシック太字
　　　Kobo他のフォント → 太字
　　　Reader → ゴシック
　- 元号の後の半角数字を縦中横
　- 「年」と「月」の間の半角数字は縦中横
　- 表題と著者を左右中央で表示 (調整中 表紙画像がある場合等)
b43 (2012/08/25)
　- ゴシック体注記対応 (Koboはデフォルトフォント時のみ有効 太字にはならない)
　- 小書きスタイル調整
　- 「ここから改行天付き、折り返して○字下げ」の「ここから」なしも対応
　　（ブロック注記扱いで次の字下げで自動で閉じる [林不忘]安重根 のみ？）
　- 外字が4バイト文字のログに出力
　- 4バイト文字の変換指定＋未変換時は注記表示
　　(Koboは4バイト文字以降行末まで表示されなくなる 2バイト文字は表示できないが文字は消えない)
　　(Readerは4バイト文字でもJIS漢字なら表示可でそれ以外も後ろの文字は消えない)
　- Zipファイル内にローマ数字があるとエラー (Zipファイルエンコード指定を"Shift_JIS"→"MS932"に変更)
b42 (2012/08/24)
　- 複数のtxtファイルの連続変換ができなくなっていたのを修正
　- 「」の含まれる前方参照注記に対応 (［＃「魔境「蕨の切り株」」は中見出し］)
　- 小書き注記対応 (［＃「○○」は小書き］)
　- 訓点返り点追加 (［＃二レ］)
　- 画像単一ページの画像位置を左右中央寄せに
b41 (2012/08/24)
　- 縦横中のタグをdivからspanに変更 (WebKit系対策)
　- 画像のタグをdivからspanに変更 (WebKit系対策)
　- 画像単ページのファイルが無い場合に目次が出ないように修正
　- 表題取得処理調整 (5行: 表題,原作表題,副題,著者,訳者)
　- 底本：自動改ページ時に前の空行を除外
　- 注記で目次が切れないように修正
　- 拡張ラテン文字注記でない〔〕を出力して内部を外字変換
　- 出力先を変換時にリストに追加 (存在しなければ追加しない)
　- コメントが短い場合にWRAN
b40 (2012/08/23)
　- 注記内の外字注記が2つ以上の場合のエラー対策
　- 縦横中変換調整 (ルビ内は適用しない等のエラー対策)
　- ローマ数字がルビ内で表示されなくなったのを修正 (ルビ内は横向き)
　- 半角スペースの前後も半角なら自動縦中横を無効に
　　(英文での誤変換防止 全角スペース区切りなら縦中横になる)
　- 画像が無い場合はimgタグを出力しない
　- 拡張子自動修正 (png, jpg, jpeg 小文字のみ)
　- １ページ目に本文がなければ目次はタイトル文字列
　- SwingWorkerでの別Threadでの実行と実行中のUIのDisable
　- 表紙画像をファイルのDnDで設定
　- 表紙画像のブラウザからのDnD動作調整 (現状末尾画像拡張子のURLのみ)
　- 表紙画像指定時に先頭画像が表示されないバグ修正
b39 (2012/08/22)
　- 《》の代替文字の前後の半角数字2文字が縦中横になるように修正
　- ローマ数字が縦中横内になければ強制縦中横
　- 1月1日のような日付表記は数字1文字も縦中横
　- 表紙画像を0000.jpg/pngにしてzip扱い時に先頭に来るようにした
　- zip画像のみの場合は画像ePub作成(仮)
　　 (リサイズ等無し Koboスクロールテスト中(なぜか左が切れる 横書き×))
b38 (2012/08/20)
　- 注記内外字は変換後に注記がつかないようにする
　- 訓点返り点追加(四,丁)
　- 単一画像ページの100%指定がされなくなっていたのを修正
　- 画像指定外字注記は画像注記に変更
　- 文中の画像は改行されないようにスタイル調整 (Koboのみ右寄せになるのは調査中)
　- 縦中横下の文中画像がずれないように調整
b37 (2012/08/15)
　- 取り消し線 二重は普通の取り消し線で代用
　- 著者名の下の余白が正しく出ていなかった
　- コメント警告行数を21行以上に変更
b36 (2012/08/15)
　- 底本の目次が出ないように修正 
　- コメントが閉じていないor長すぎる場合警告表示
b35 (2012/08/15)
　- 半角＆の変換漏れ
　- 見出し終わり注記のログ出力抑制 （インライン注記で閉じていない場合用にコメントアウトしていたため）
b34 (2012/08/14)
　- 変則注記にさらに対応
　- ログ出過ぎなので明確な非対応注記は出さない
　- ［＃字下げ終わり］に対応
b33 (2012/08/14)
　- 画像は拡張子の . がある物のみ
　- 字下げ複合注記で開始していなかった場合に字下げ終了タグを出さない
　- 字下げが閉じていない場合等のエラーをログに表示 (xhtmlエラーの可能性有り)
　- ［＃ここから○字下げ。］も判別
　- 破線罫囲み、枠囲み、破線枠囲みに対応
　- 変換エラー確認用に未変換の注記をすべてログに出力
　- 返り点前方参照注記に対応
　- 「底本：」前に改ページがなかったら改ページ（目次には表示しない）
b32 (2012/08/14)
　- 改行のみの行が出ない場合があったので改行をpで括る
　- 表題取得を青空文庫記載事項に合わせ、本文中のスタイルも調整
　　(表題 原題 副題 副原題 著者名 訳者名 / 表題 副題 著者名 訳者名 / 表題 副題 著者名 / 表題 著者名)
b31 (2012/08/13)
　- 複合字下げ注記終わりでのエラー対応 (［＃ここで字下げ、罫囲み終わり］等)
b30 (2012/08/13)
　- 出力先パス履歴(最大10件)
　- 先頭画像が表紙で表示出力で画像単ページの場合に空ページが出ていたのを修正
　- imgタグで src=画像ファイル.jpg のように"か'で括られていない場合に対応
　- ファイル名の拡張子より前に . がついていた場合に対応
b29 (2012/08/12)
　- 入力ファイルのサブフォルダ以下すべてのファイルに対応
　- 字下げ複合注記に対応 (字下げ、罫囲み、中央揃え)のみ
　- 罫囲みの高さが常にページ下までになっていたので文字に合うようにスタイル調整(display:inline-block)
b28 (2012/08/12)
　- ページ左右中央じ地付き地上げのスタイル調整
　- cssファイルの共通部分分割
b27 (2012/08/11)
　- 先頭が画像＋改ページの場合、先頭画像を表紙ページで出力すると空ページができるバグ修正
b26 (2012/08/11)
　- 地付き、地上げが効かなくなっていたのでスタイル調整
b25 (2012/08/11)
　- ページの左右中央注記に対応
　- 改ページ前の空白行を除去 (余計な空白ページがでないように)
　- 禁則処理での下の空行をなくすため p {text-align: justify;} を追加
　- 文字列置換 (本文とルビに適用) の置換前文字を２文字まで対応 (replace_sample.txtをリネームして利用)
b24 (2012/08/09)
　- 文字列置換設定ファイル(replace.txt)追加 (本文とルビに適用)
b23 (2012/08/08)
　- 傍線スタイルをundreline→border-right/leftに変更 (二重線・破線・点線対応)
　- 画像注記エラー処理調整 (注記内で（が閉じていない場合)
　- 出力先パス指定
　- 表紙ページがあれば目次に「表紙」追加 
b22 (2012/08/07)
　- 文字置換 (<<>>＜＜＞＞を《》に 3個以上はそのまま)
　- 文字置換（“”を〝〟に XMDF用に逆に変換していたのは修正）
　- Kobo栞用IDを行のpにつける (栞が数行ずれる場合があるが少し軽量化)
b21 (2012/08/06)
　- 表紙ページ追加で先頭の挿絵を利用した場合は本文中から削除
　- 画像にmax-height:100%(横書きならmax-width:100%)を設定して大きい画像に対応 (横に長いと左がはみ出る)
　- cssのclass文字数を減らした
　- 余計な br や p が出ていたのを修正
b20 (2012/08/05)
　- 表題下のコメント行処理Bugfix 
　- 地付き地上げスタイル調整
b19 (2012/08/05)
　- ファイル名からタイトル取得でのNullPointer例外を修正
　- 表紙に入力ファイルと同じファイル名(拡張子以外)の画像を利用
　- 訓点送り仮名に対応
　- 画像ページは画像注記のタイトルまたは<imgタグのaltを目次に設定
b18 (2012/08/04)
　- 改行を<br/>から<p></p>括りに変更 (kepubだと特に変わらず)
　- ページの左右中央で余計な改ページが出ていたので改ページなしに
　- 2行目がコメントブロック-54文字になら著者は取得しない
　- ファイル名文字制限エラー対策で256文字以下に(著者名max64文字)
　- toc.ncxで空ページのChapterの制御文字が出ていた
b17 (2012/08/04)
　- ページ余白を@pageで指定 (余白0.5文字(左は0) Readerのルビ欠け対策)
b16 (2012/08/04)
　- 表紙ページ出力(仮)
　- 強制改ページ機能(未完成)を無効に
b15 (2012/08/03)
　- ここで字下げ終わりの複合注記に対応
b14 (2012/08/03)
　- 確認ダイアログ調整
　- toc.ncx出力
　- 画像単ページの目次をファイル名に
　- 中央揃え注記(仕様外)に対応
　- 訓点(返り点)注記に対応
　- 画像注記は . がなければ訓点送り仮名
　- 表示できない外字は小書きで注記を表示
b13 (2012/08/03)
　- 画像単ページ調整 (［＃（画像.jpg）］注記がマッチしていなかった)
b12 (2012/08/02)
　- 表題の確認ダイアログ表示
　- 表題行が「表題＋著者名」の場合は3行以上なら2行目を副題にする
　- 字下げ折り返しの文字数設定間違い修正
b11 (2012/08/01)
　- ePubの最新仕様に合わせてメタデータ等調整 (参考にしたePub3が古かったため)
　- 画像単ページ時に画像全体表示用スタイル適用
　　(上下の行が［＃改ページ］で挟まれている画像注記、先頭行の画像は下が［＃改ページ］のxhtmlのみ)
　- タイトル取得と画像単ページ判別の前処理の修正
　- UTF-8以外の外字はルビに注記表示
b10
　- <IMG SRC= の大文字表記にも対応
　- 字下げの複合注記は、字下げのみ最低限処理してxhtmlエラーを回避
b9
　- "<"→"&lt;" ">"→"&gt;" にすべて置換 (「<メールアドレス>」等の記載に対応) 
　- <a .*></a>タグ削除
　- ファイル名からタイトルと作者指定 ("[著作者] タイトル (青空文庫).zip")
　- 目次(仮) (本文先頭行＋改ページ後の先頭本文で設定(Max64文字))
　- 折り返し字下げ注記で2行目以降のインデントずれを修正 (各行を<p></p>で括る ブロック注記の行は括らない)
　- 字詰めスタイル調整 (divに字詰め文字数のmax-height指定)
　- 複合注記［＃ここから○字下げ、○字詰め］［＃ここから○字下げ、罫囲み］対応
　- 改ページ処理の改行を出力しない 画像の改行も無くして<div><img></div>に
　- kepub栞対応 (拡張子.kepub.epub時のみ)
　- 表紙ファイル指定 (ファイル選択,URL,先頭の挿絵, 表紙なし)
　- 出力ファイルを setWritable(true)
　- コマンドラインからの実行に対応(仮) (引数 ファイル複数 オプション未対応)

[1.0.5u1] - date: 2012/07/24
　- 改ページの後ろの改行が次ページの先頭に出ていたのを修正
[1.0.5] - date: 2012/07/24
　- 注記対応 (字詰め、罫囲み、字下げ内の罫囲み)
　- タグを p から div に変更してスタイルも調整
　- 閉じていない［＃見出し］注記のタグエラー対策に必ず１行で閉じる (［＃見出し終わり］は無視)
　- 画像を含むzipファイルに対応
　- コマンドラインからの実行に対応(仮) (引数ファイル名1個のみ)

[1.0.4u1] - date: 2012/07/23
　- 小見出し注記でのタグ設定間違いのみchuki_tag.txt修正
[1.0.4] - date: 2012/07/22
　- 傍線スタイル調整
　- 縦書き横書き切り替え設定
　- 外字注記 UCS-コードに対応 (U+と同じ)

[1.0.3] - date: 2012/07/22
　- 縦中横、圏点スタイル調整 (-webkit -epub 記述追加)
　- 訓点が画像として扱われてしまったのを修正 (１文字なら訓点)
　- 拡張子を選択式に
　- Windowサイズを記憶
　- 圧縮率を調整 (画像は非圧縮)
　- nav.xhtml(仮)を出力

[1.0.2] - date: 2012/07/22
　- スタイルの width:100% 削除 
　- すべての画像にカバー画像指定が入っていたのを修正 (先頭のみ設定) 
　- 画像注記 ［＃（表紙.jpg）］ が読めていなかったのを修正 
　- Window位置を記憶

[1.0.1] - date: 2012/07/21
　- スタイルのフォント色と余白を調整
　- zip内のtxtファイル１つのみ変換に対応 (zip内画像、複数txtは未対応)
　- 出力ファイルの拡張子指定

[1.0] - date: 2012/07/21
　- AozoraXMDFの注記設定を変更してePub3対応版を作成
　- Zipアーカイブ形式でePub3ファイル一式を出力

=== TODO =======================================================================
TODO
Milestone1.0.6
　- 動作確認

Milestone1.0.7
　- 画像サイズによるスタイル調整(RMSDKの場合はみ出るため)
　　(縦長画像 800以上は width:auto; height:100%; 横長画像 600以上は width:100%; height:auto;)
　- 指定サイズ以上の画像は余白なしの単ページ化 (要ブロック注記内かのチェック)
　- 複数テキストを結合(仮) (ファイル名順、目次は各タイトル、Zip内1テキストのみ)
　- コメント行前の表題と著者の左右中央指定
　- 確認画面で表紙のプレビュー表示 (トリミングもできたらやる)

優先度高
　- 未対応の青空注記への対応 (横書き、窓見出し、割り注) 
　- 設定ボタンと設定ダイアログで詳細設定 
　- UTF-32文字や外字の代替文字での表示
　- 4バイト文字内のJIS漢字は表示するオプション
優先度高 目次関連
　- 見出しや数字のみの行で目次生成 (文中目次も作成)
　- 目次編集機能の実装 (出力する目次の選択、行の調整、目次文字変更)
　- 目次出力設定 (見出し、改ページ毎のデフォルト設定)
優先度中 自動改ページ 挿絵
　- ブロック注記の階層取得 (自動改ページ用)
　- 見出しで改ページ (ブロック注記外のみ)
　- 指定空行とパターンで改ページ (ブロック注記外のみ)
他
　- 複数テキストを結合 Zip内複数テキストも対応 (目次自動取得調整と編集画面で設定)
　- コメントブロック表示・非表示設定 (54文字の"-"の間を 表示、非表示、小さく表示 から選択)
　- css調整機能と機種プリセット切り替え
　- Reader用フォント埋め込み設定
　- RAR対応
　- 同じ文字が続く場合のword-break設定
